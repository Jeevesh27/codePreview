<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quick Sort ⚡ — Bar Chart</title>
<style>
  :root{
    --bg:#0f1220; --panel:#161a2d; --panel-2:#1e2340;
    --text:#ecf2ff; --muted:#a6b0cf;
    --pair:#ffd166; --active:#6cf3ff; --done:#8ae9c1;
    --edge:#556; --edge-pair:#e3b84a; --edge-done:#6fae97;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: radial-gradient(1200px 800px at 70% -10%, #20264a 0%, var(--bg) 40%);
    color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    min-height:100vh; padding:32px 16px 64px; display:grid; place-items:start center;
  }
  .app{ width:min(1100px,100%); display:grid; gap:16px; }

  .panel{
    background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
    border:1px solid #1a2040; border-radius:14px; box-shadow:var(--shadow); padding:18px;
  }
  .title-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  h1{ margin:0; font-size:clamp(22px,3vw,28px);}
  .badge{ background:#0b1022; border:1px solid #28305a; color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px; display:inline-flex; gap:6px; align-items:center;}
  .badge b{ color:var(--text); }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  label{ color:var(--muted); font-size:14px;}
  input[type="number"]{
    background:#0d1126; border:1px solid #242b51; color:var(--text); border-radius:10px; padding:8px 10px; outline:none;
  }
  input[type="range"]{ accent-color: var(--active); }
  button{
    background:#0e1736; color:var(--text); border:1px solid #2b3563; border-radius:12px; padding:10px 14px; cursor:pointer;
    transition:transform .05s ease, background .15s ease, border-color .15s ease;
  }
  button:hover{ background:#121c44; }
  button:active{ transform:translateY(1px); }
  button.primary{ background:linear-gradient(180deg,#0f2b3a,#0b1f2b); border-color:#284a60; }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  /* Chart */
  .chart{
    height:360px; display:flex; align-items:flex-end; gap:8px;
    padding:12px; border-radius:12px; background:#101634; border:1px solid #222a55; overflow-x:auto;
  }
  .bar{
    --w: 26px;
    width: var(--w);
    background: linear-gradient(180deg, #0c1128, #0a0f22);
    border:1px solid #27305b; border-radius:8px 8px 4px 4px;
    display:flex; align-items:flex-end; justify-content:center;
    position:relative;
    transition: height .28s ease, background .2s ease, outline .2s ease, filter .2s ease, opacity .2s ease, border-color .2s ease;
    box-shadow: inset 0 0 0 1px #0b1026, var(--shadow);
  }
  .bar .label{
    position:absolute; top:-22px; left:50%; transform:translateX(-50%);
    font:11px/1 ui-monospace, Menlo, Consolas; color:var(--muted);
    background:#0b1026; padding:3px 6px; border-radius:6px; border:1px solid #222a55;
    pointer-events:none;
  }
  .bar.inactive{ opacity:.35; filter:grayscale(.4); }
  .bar.seg{ background:#0f1430; }
  .bar.pivot{ outline:3px solid var(--pair); }
  .bar.store{ outline:2px solid var(--active); }
  .bar.scan { outline:2px dashed var(--active); }
  .bar.swap { border-color: var(--edge-pair); }
  .bar.done { background:#0d1f22; border-color: var(--edge-done); }
  .bar.done::after{
    content:"✓"; position:absolute; bottom:-18px; left:50%; transform:translateX(-50%);
    font-size:12px; color:var(--done);
  }

  .legend{ display:flex; gap:14px; flex-wrap:wrap; color:var(--muted); font-size:14px;}
  .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; vertical-align:middle;}
  .dot.active{ background:var(--active); }
  .dot.pair{ background:var(--pair); }
  .dot.done{ background:var(--done); }

  pre{ margin:0; background:#0b1026; border:1px solid #222a55; border-radius:12px; padding:14px; overflow:auto; box-shadow:var(--shadow); color:var(--text);}
  code{ font:13px/1.45 ui-monospace, Menlo, Consolas; }
  .muted{ color:var(--muted); }
</style>
</head>
<body>
<main class="app">
  <section class="panel">
    <div class="title-row">
      <h1>Quick Sort ⚡ — Partition around a pivot</h1>
      <span class="badge">Avg: <b>O(n log n)</b></span>
      <span class="badge">Worst: <b>O(n²)</b></span>
      <span class="badge">Space: <b>O(log n)</b> (stack)</span>
    </div>
  </section>

  <section class="panel">
    <div class="row">
      <label>Size</label>
      <input id="size" type="number" min="3" max="120" value="24" style="width:90px" />
      <button id="random" class="primary">Randomize</button>
      <button id="nearly">Nearly-sorted</button>
      <span class="badge">Segment: <b id="segLbl">–</b></span>
      <span class="badge">Stack: <b id="stkLbl">0</b></span>
      <span class="badge">Depth (peak): <b id="depLbl">0</b></span>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="play" class="primary">▶ Play</button>
      <button id="step">⏭ Step</button>
      <button id="reset">♻ Reset</button>
      <label style="margin-left:8px;">Speed</label>
      <input id="speed" type="range" min="0" max="100" value="45" />
      <span id="speedLabel" class="muted">Medium</span>
      <span class="badge">Comparisons: <b id="cmp">0</b></span>
      <span class="badge">Swaps: <b id="swp">0</b></span>
    </div>
  </section>

  <section class="panel chart" id="chart" aria-label="Bar chart"></section>
  <div class="legend panel">
    <span><span class="dot pair"></span> Pivot</span>
    <span><span class="dot active"></span> i (store) / j (scan)</span>
    <span><span class="dot done"></span> Fixed position</span>
  </div>

  <section class="panel">
    <h2 style="margin:0 0 10px;">Pseudo-code (Lomuto partition)</h2>
<pre><code>function quicksort(arr, lo, hi):
    if lo &lt; hi:
        p ← partition(arr, lo, hi)
        quicksort(arr, lo, p-1)
        quicksort(arr, p+1, hi)

function partition(arr, lo, hi):
    pivot ← arr[hi]
    i ← lo - 1
    for j ← lo to hi-1:
        if arr[j] ≤ pivot:
            i ← i + 1
            swap(arr[i], arr[j])
    swap(arr[i+1], arr[hi])
    return i+1
</code></pre>
    <p class="muted">We move elements ≤ pivot to the left, then place the pivot in the gap. That index is final (marked ✓), and we recurse on the two sides.</p>
  </section>
</main>

<script>
  // ---------- State ----------
  const state = {
    arr: [],
    n: 0,
    stack: [],       // frames: {lo,hi,phase,i,j,pIdx,pivot}
    cur: null,       // current frame being processed
    doneSet: new Set(),
    comparisons: 0,
    swaps: 0,
    running: false,
    delay: 380,
    peakDepth: 0,
    swapPair: null   // {a,b} for visual emphasis
  };

  // ---------- DOM ----------
  const elChart = document.getElementById('chart');
  const elSize  = document.getElementById('size');
  const btnRandom = document.getElementById('random');
  const btnNearly = document.getElementById('nearly');
  const btnPlay = document.getElementById('play');
  const btnStep = document.getElementById('step');
  const btnReset = document.getElementById('reset');
  const elSpeed= document.getElementById('speed');
  const elSpeedLabel = document.getElementById('speedLabel');
  const elSeg  = document.getElementById('segLbl');
  const elStk  = document.getElementById('stkLbl');
  const elDep  = document.getElementById('depLbl');
  const elCmp  = document.getElementById('cmp');
  const elSwp  = document.getElementById('swp');

  // ---------- Utils ----------
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const wait =(ms)=>new Promise(r=>setTimeout(r,ms));
  function speedToDelay(v){ const t=clamp(v,0,100)/100; const eased=1-Math.pow(t,1.6); return 60+Math.round(eased*740); }
  function labelSpeed(v){ v=+v; if(v<20) return 'Fastest'; if(v<40) return 'Fast'; if(v<60) return 'Medium'; if(v<80) return 'Slow'; return 'Slowest'; }
  function randomArray(n){ return Array.from({length:n},()=>Math.floor(Math.random()*95)+5); }
  function nearlySortedArray(n){
    const base = Array.from({length:n},(_,i)=>Math.round((i+1)*100/n));
    for (let k=0;k<Math.max(1, Math.floor(n*0.08));k++){
      const a=Math.floor(Math.random()*n), b=clamp(a+(Math.random()<0.5?-1:1),0,n-1);
      [base[a], base[b]] = [base[b], base[a]];
    }
    return base;
  }
  function maxVal(arr){ return arr.reduce((m,v)=>v>m?v:m, -Infinity); }

  // ---------- Chart ----------
  function buildChart(){
    elChart.innerHTML = '';
    const M = maxVal(state.arr)||1;
    state.arr.forEach((v, idx)=>{
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.dataset.index = idx;
      bar.style.height = `${(v/M)*100}%`;
      bar.innerHTML = `<div class="label">${v}</div>`;
      elChart.appendChild(bar);
    });
    paint();
  }
  function getBar(i){ return elChart.children[i]; }
  function setBarValue(i, val){
    const M = maxVal(state.arr)||1;
    const bar = getBar(i); if(!bar) return;
    bar.style.height = `${(val/M)*100}%`;
    bar.querySelector('.label').textContent = val;
  }
  function clearMarks(){
    [...elChart.children].forEach(b=> b.classList.remove('inactive','seg','pivot','store','scan','swap','done'));
  }

  // ---------- Painting ----------
  function paint(){
    clearMarks();

    // mark done (fixed pivots)
    state.doneSet.forEach(idx=> getBar(idx)?.classList.add('done'));

    const depth = state.stack.length + (state.cur ? 1 : 0);
    elStk.textContent = depth;
    if (depth > state.peakDepth) state.peakDepth = depth;
    elDep.textContent = state.peakDepth;
    elCmp.textContent = state.comparisons;
    elSwp.textContent = state.swaps;

    if (state.cur){
      const {lo,hi,pIdx,i,j} = state.cur;
      elSeg.textContent = `${lo}..${hi}`;

      for (let x=0;x<state.n;x++){
        if (x < lo || x > hi) getBar(x)?.classList.add('inactive');
        else getBar(x)?.classList.add('seg');
      }
      if (typeof pIdx === 'number') getBar(pIdx)?.classList.add('pivot');
      if (typeof i === 'number' && i >= lo-1 && i < hi) getBar(i+1)?.classList.add('store'); // store pointer points to i+1
      if (typeof j === 'number' && j >= lo && j < hi) getBar(j)?.classList.add('scan');

      if (state.swapPair){
        const {a,b} = state.swapPair;
        getBar(a)?.classList.add('swap');
        getBar(b)?.classList.add('swap');
      }
    } else {
      elSeg.textContent = '–';
    }
  }

  // ---------- Quick Sort Engine (Lomuto, iterative frames) ----------
  function pushFrame(lo, hi){
    if (lo >= hi){
      if (lo === hi) state.doneSet.add(lo); // single element already in place
      return;
    }
    state.stack.push({lo,hi,phase:'start',i:lo-1,j:lo,pIdx:hi,pivot:null});
  }

  function beginFrame(frame){
    frame.pIdx = frame.hi;
    frame.pivot = state.arr[frame.pIdx];
    frame.i = frame.lo - 1;
    frame.j = frame.lo;
    frame.phase = 'scan';
  }

  function doSwap(a,b){
    if (a === b) return false; // don't count trivial self-swaps
    const tmp = state.arr[a]; state.arr[a] = state.arr[b]; state.arr[b] = tmp;
    setBarValue(a, state.arr[a]); setBarValue(b, state.arr[b]);
    return true;
  }

  function stepOnce(){
    // fetch frame if none
    if (!state.cur){
      while (state.stack.length && !state.cur){
        const f = state.stack.pop();
        if (f.lo >= f.hi){
          if (f.lo === f.hi) state.doneSet.add(f.lo);
        } else {
          state.cur = f;
        }
      }
      if (!state.cur){
        // finished
        // mark all as done visually
        for (let i=0;i<state.n;i++) getBar(i)?.classList.add('done');
        state.running = false; btnPlay.textContent='▶ Play'; return;
      }
      if (state.cur.phase === 'start') beginFrame(state.cur);
      paint();
      return;
    }

    const f = state.cur;

    if (f.phase === 'scan'){
      if (f.j <= f.hi - 1){
        // compare arr[j] with pivot
        state.comparisons++;
        paint();

        if (state.arr[f.j] <= f.pivot){
          // swap arr[i+1], arr[j]
          const a = f.i + 1, b = f.j;
          state.swapPair = {a,b};
          const did = doSwap(a,b);
          if (did) state.swaps++;
          f.i = f.i + 1;
          f.j = f.j + 1;
          // clear pair after drawing
          setTimeout(()=>{ state.swapPair = null; paint(); }, 0);
          paint();
          return;
        } else {
          f.j = f.j + 1;
          paint();
          return;
        }
      } else {
        f.phase = 'final';
        paint();
        return;
      }
    }

    if (f.phase === 'final'){
      // place pivot at i+1
      const a = f.i + 1, b = f.pIdx;
      state.swapPair = {a,b};
      const did = doSwap(a,b);
      if (did) state.swaps++;
      state.swapPair = null;

      const p = a; // pivot final index
      state.doneSet.add(p);

      // push subsegments (process larger first to keep stack shallow)
      const leftLo=f.lo, leftHi=p-1, rightLo=p+1, rightHi=f.hi;
      const leftLen  = Math.max(0, leftHi-leftLo+1);
      const rightLen = Math.max(0, rightHi-rightLo+1);
      if (leftLen > rightLen){
        pushFrame(leftLo, leftHi);
        pushFrame(rightLo, rightHi);
      } else {
        pushFrame(rightLo, rightHi);
        pushFrame(leftLo, leftHi);
      }

      state.cur = null; // done with this frame
      paint();
      return;
    }
  }

  async function run(){
    if (state.running){
      state.running = false;
      btnPlay.textContent = '▶ Play';
      return;
    }
    state.running = true;
    btnPlay.textContent = '⏸ Pause';
    while (state.running){
      stepOnce();
      await wait(state.delay * 0.5);
      // break when fully finished
      if (!state.cur && state.stack.length === 0 && state.doneSet.size === state.n){
        state.running = false;
      }
    }
    btnPlay.textContent = '▶ Play';
  }

  // ---------- Controls ----------
  function reset(arr){
    state.arr = arr.slice();
    state.n = state.arr.length;
    state.stack = [];
    state.cur = null;
    state.doneSet = new Set();
    state.comparisons = 0;
    state.swaps = 0;
    state.running = false;
    state.peakDepth = 0;
    btnPlay.textContent = '▶ Play';
    buildChart();
    pushFrame(0, state.n-1);
    paint();
  }

  btnRandom.addEventListener('click', ()=>{
    const n = clamp(parseInt(elSize.value||'0',10), 3, 120);
    elSize.value = n;
    reset(randomArray(n));
  });

  btnNearly.addEventListener('click', ()=>{
    const n = clamp(parseInt(elSize.value||'0',10), 3, 120);
    elSize.value = n;
    reset(nearlySortedArray(n));
  });

  btnPlay.addEventListener('click', run);
  btnStep.addEventListener('click', stepOnce);
  btnReset.addEventListener('click', ()=> reset(state.arr));

  elSpeed.addEventListener('input', (e)=>{
    state.delay = speedToDelay(+e.target.value);
    elSpeedLabel.textContent = labelSpeed(+e.target.value);
  });

  // ---------- Init ----------
  (function init(){
    const n = clamp(parseInt(elSize.value||'0',10), 3, 120);
    elSize.value = n;
    state.delay = speedToDelay(+elSpeed.value);
    elSpeedLabel.textContent = labelSpeed(+elSpeed.value);
    reset(randomArray(n));
  })();
</script>
</body>
</html>
